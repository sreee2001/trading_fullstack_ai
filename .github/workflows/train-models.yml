name: Train Models

on:
  schedule:
    # Run daily at 2 AM UTC (adjust timezone as needed)
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      commodities:
        description: 'Commodities to train (comma-separated: WTI,BRENT,NG)'
        required: false
        default: 'WTI,BRENT,NG'
      model_types:
        description: 'Model types to train (comma-separated: arima,prophet,lstm)'
        required: false
        default: 'arima,prophet,lstm'
      horizon:
        description: 'Forecast horizon in days'
        required: false
        default: '7'
      retrain:
        description: 'Retrain existing models'
        required: false
        default: 'false'
        type: boolean

jobs:
  train:
    name: Train ML Models
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hour timeout
    
    services:
      postgres:
        image: timescale/timescaledb:latest-pg15
        env:
          POSTGRES_USER: energy_user
          POSTGRES_PASSWORD: energy_password
          POSTGRES_DB: energy_forecasting
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client gcc g++

      - name: Install Python dependencies
        working-directory: src/energy-price-forecasting
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup MLflow tracking
        run: |
          mkdir -p mlruns
        working-directory: src/energy-price-forecasting

      - name: Parse workflow inputs
        id: parse-inputs
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "commodities=${{ github.event.inputs.commodities }}" >> $GITHUB_OUTPUT
            echo "model_types=${{ github.event.inputs.model_types }}" >> $GITHUB_OUTPUT
            echo "horizon=${{ github.event.inputs.horizon }}" >> $GITHUB_OUTPUT
            echo "retrain=${{ github.event.inputs.retrain }}" >> $GITHUB_OUTPUT
          else
            echo "commodities=WTI,BRENT,NG" >> $GITHUB_OUTPUT
            echo "model_types=arima,prophet,lstm" >> $GITHUB_OUTPUT
            echo "horizon=7" >> $GITHUB_OUTPUT
            echo "retrain=false" >> $GITHUB_OUTPUT
          fi

      - name: Train models
        working-directory: src/energy-price-forecasting
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: energy_forecasting
          DB_USER: energy_user
          DB_PASSWORD: energy_password
          EIA_API_KEY: ${{ secrets.EIA_API_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          MLFLOW_TRACKING_URI: file://${{ github.workspace }}/src/energy-price-forecasting/mlruns
        run: |
          python -m training.train_all_models \
            --commodities ${{ steps.parse-inputs.outputs.commodities }} \
            --model-types ${{ steps.parse-inputs.outputs.model_types }} \
            --horizon ${{ steps.parse-inputs.outputs.horizon }} \
            $([ "${{ steps.parse-inputs.outputs.retrain }}" == "true" ] && echo "--retrain" || echo "") \
            --output training_results.json

      - name: Upload training results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: training-results
          path: |
            src/energy-price-forecasting/training_results.json
            src/energy-price-forecasting/mlruns/**/*

      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mlflow-artifacts
          path: src/energy-price-forecasting/mlruns/
          retention-days: 30

      - name: Report training summary
        if: always()
        run: |
          if [ -f src/energy-price-forecasting/training_results.json ]; then
            echo "## Training Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat src/energy-price-forecasting/training_results.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "Model training failed. Check logs for details."
          # Add notification logic here (Slack, email, etc.)

